{% extends "base.html" %}

{% block title %}{{ movie.title }} - Movie Analytics Dashboard{% endblock %}

{% block content %}

<!-- Feature 1: Backdrop Banner -->
{% if movie.backdrop_path %}
<div class="backdrop-banner mb-4">
    <img src="{{ config.get_backdrop_url(movie.backdrop_path) }}"
         alt="{{ movie.title }} backdrop"
         class="backdrop-image">
    <div class="backdrop-overlay"></div>
    <div class="backdrop-content">
        <h1 class="display-4 fw-bold text-white mb-0">{{ movie.title }}</h1>
        {% if movie.tagline %}
        <p class="lead text-white-50 mb-0">{{ movie.tagline }}</p>
        {% endif %}
    </div>
</div>
{% else %}
<h1 class="mb-4">{{ movie.title }}</h1>
{% if movie.tagline %}
<p class="lead text-muted mb-3">{{ movie.tagline }}</p>
{% endif %}
{% endif %}

<div class="row">
    <!-- Poster -->
    <div class="col-md-3 mb-4">
        {% if movie.poster_path %}
        <img src="{{ config.get_poster_url(movie.poster_path) }}"
             class="img-fluid rounded shadow"
             alt="{{ movie.title }}">
        {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 450px;">
            <i class="bi bi-film" style="font-size: 3rem; color: #666;"></i>
        </div>
        {% endif %}

        <!-- Favorites / Watchlist Buttons -->
        {% if current_user %}
        <div class="mt-3 d-grid gap-2">
            <button
                id="favorite-btn"
                class="btn btn-{% if is_favorited %}danger{% else %}outline-danger{% endif %}"
                onclick="toggleFavorite({{ movie.id }})"
            >
                <i class="bi bi-heart-fill me-1"></i>
                {% if is_favorited %}Unfavorite{% else %}Favorite{% endif %}
            </button>
            <button
                id="watchlist-btn"
                class="btn btn-{% if is_in_watchlist %}primary{% else %}outline-primary{% endif %}"
                onclick="toggleWatchlist({{ movie.id }})"
            >
                <i class="bi bi-bookmark-fill me-1"></i>
                {% if is_in_watchlist %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}
            </button>
        </div>
        {% else %}
        <div class="mt-3">
            <div class="alert alert-info text-center small py-2">
                <a href="{{ url_for('login', next=request.path) }}" class="alert-link">Log in</a> to save this movie to your favorites or watchlist
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Details + Trailer -->
    <div class="col-md-9">
        <!-- Overview -->
        <p class="lead">{{ movie.overview }}</p>

        <!-- Quick Stats -->
        <div class="row mt-3 mb-3">
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-star-fill text-warning"></i> Rating</strong>
                <p>{{ movie.vote_average }}/10 ({{ movie.vote_count }} votes)</p>
            </div>
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-calendar"></i> Release Date</strong>
                <p>{{ movie.release_date|format_date }}</p>
            </div>
            {% if movie.runtime %}
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-clock"></i> Runtime</strong>
                <p>{{ movie.runtime|format_runtime }}</p>
            </div>
            {% endif %}
            {% if movie.original_language %}
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-translate"></i> Language</strong>
                <p>{{ movie.original_language|upper }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Genres -->
        {% if movie.genres %}
        <div class="mb-3">
            <strong>Genres:</strong>
            {% for genre in movie.genres %}
            <a href="{{ url_for('movies', genre=genre.id) }}" class="badge bg-primary text-decoration-none me-1">
                {{ genre.name }}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Directors -->
        {% if directors %}
        <p><strong>Director{{ 's' if directors|length > 1 }}:</strong>
            {% for crew, person in directors %}
            {{ person.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <!-- Trailer -->
        {% if trailer %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle-fill text-danger"></i>
                    {{ trailer.name|default('Official Trailer') }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe
                        src="https://www.youtube.com/embed/{{ trailer.key }}"
                        title="{{ trailer.name|default('Movie Trailer') }}"
                        allowfullscreen
                        loading="lazy"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Feature 2: Runtime, Budget, and Revenue Details -->
{% if movie.budget or movie.revenue or movie.runtime %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-info-circle me-2"></i>Financial Details
                </h5>
                <div class="row">
                    {% if movie.budget %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Budget</h6>
                        <p class="h5">{{ movie.budget|format_currency }}</p>
                    </div>
                    {% endif %}

                    {% if movie.revenue %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Revenue</h6>
                        <p class="h5">{{ movie.revenue|format_currency }}</p>
                    </div>
                    {% endif %}

                    {% if movie.budget and movie.revenue %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Profit/Loss</h6>
                        {% set profit = movie.revenue - movie.budget %}
                        <p class="h5 {% if profit > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ profit|format_currency }}
                        </p>
                    </div>

                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">ROI</h6>
                        {% set roi = ((movie.revenue - movie.budget) / movie.budget * 100) if movie.budget > 0 else 0 %}
                        <p class="h5 {% if roi > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(roi) }}%
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cast -->
{% if cast %}
<h3 class="mt-4 mb-3">
    <i class="bi bi-people-fill me-2"></i>Top Cast
</h3>
<div class="row">
    {% for cast_member, person in cast %}
    <div class="col-md-2 col-sm-4 col-6 mb-3 text-center">
        {% if person.profile_path %}
        <img src="{{ config.get_poster_url(person.profile_path, 'w185') }}"
             class="rounded-circle mb-2 shadow-sm"
             style="width: 100px; height: 100px; object-fit: cover;"
             alt="{{ person.name }}">
        {% else %}
        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-2 mx-auto shadow-sm"
             style="width: 100px; height: 100px;">
            <i class="bi bi-person" style="font-size: 2rem; color: #999;"></i>
        </div>
        {% endif %}
        <p class="small mb-0"><strong>{{ person.name }}</strong></p>
        <p class="small text-muted">{{ cast_member.character_name }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Similar Movies -->
{% if similar_movies %}
<h3 class="mt-5 mb-3">
    <i class="bi bi-collection-play me-2"></i>Similar Movies
</h3>
<div class="row">
    {% for similar_movie in similar_movies %}
    <div class="col-md-2 col-sm-4 col-6 mb-4">
        <a href="{{ url_for('movie_detail', movie_id=similar_movie.id) }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm hover-card">
                {% if similar_movie.poster_path %}
                <img src="{{ config.get_poster_url(similar_movie.poster_path, 'w342') }}"
                     class="card-img-top"
                     alt="{{ similar_movie.title }}"
                     style="height: 250px; object-fit: cover;">
                {% else %}
                <div class="bg-secondary d-flex align-items-center justify-content-center"
                     style="height: 250px;">
                    <i class="bi bi-film" style="font-size: 2rem; color: #666;"></i>
                </div>
                {% endif %}
                <div class="card-body p-2">
                    <p class="small mb-1 text-dark"><strong>{{ similar_movie.title }}</strong></p>
                    <p class="small text-muted mb-0">
                        <i class="bi bi-star-fill text-warning"></i> {{ similar_movie.vote_average }}
                    </p>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
.hover-card {
    transition: transform 0.2s ease-in-out;
}

.hover-card:hover {
    transform: translateY(-5px);
}
</style>

<!-- Favorites / Watchlist JavaScript -->
<script>
async function toggleFavorite(movieId) {
    const btn = document.getElementById('favorite-btn');
    const isFavorited = btn.textContent.trim().includes('Unfavorite');
    const url = `/movie/${movieId}/${isFavorited ? 'unfavorite' : 'favorite'}`;

    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
        if (isFavorited) {
            btn.innerHTML = '<i class="bi bi-heart-fill me-1"></i>Favorite';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-outline-danger');
        } else {
            btn.innerHTML = '<i class="bi bi-heart-fill me-1"></i>Unfavorite';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
        }
    }
}

async function toggleWatchlist(movieId) {
    const btn = document.getElementById('watchlist-btn');
    const inWatchlist = btn.textContent.trim().includes('Remove from Watchlist');
    const url = `/movie/${movieId}/${inWatchlist ? 'unwatchlist' : 'watchlist'}`;

    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
        if (inWatchlist) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i>Add to Watchlist';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        } else {
            btn.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i>Remove from Watchlist';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        }
    }
}
</script>

{% endblock %}
