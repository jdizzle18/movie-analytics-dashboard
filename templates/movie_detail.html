{% extends "base.html" %}

{% block title %}{{ movie.title }} - Movie Analytics Dashboard{% endblock %}

{% block content %}

<!-- Backdrop Banner -->
{% if movie.backdrop_path %}
<div class="backdrop-banner mb-4">
    <img src="{{ config.get_backdrop_url(movie.backdrop_path) }}"
         alt="{{ movie.title }} backdrop"
         class="backdrop-image">
    <div class="backdrop-overlay"></div>
    <div class="backdrop-content">
        <h1 class="display-4 fw-bold text-white mb-0">{{ movie.title }}</h1>
        {% if movie.tagline %}
        <p class="lead text-white-50 mb-0">{{ movie.tagline }}</p>
        {% endif %}
    </div>
</div>
{% else %}
<h1 class="mb-4">{{ movie.title }}</h1>
{% if movie.tagline %}
<p class="lead text-muted mb-3">{{ movie.tagline }}</p>
{% endif %}
{% endif %}

<div class="row">
    <!-- Poster -->
    <div class="col-md-3 mb-4">
        {% if movie.poster_path %}
        <img src="{{ config.get_poster_url(movie.poster_path) }}"
             class="img-fluid rounded shadow"
             alt="{{ movie.title }}">
        {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 450px;">
            <i class="bi bi-film" style="font-size: 3rem; color: #666;"></i>
        </div>
        {% endif %}

        <!-- Favorites / Watchlist Buttons -->
        {% if current_user %}
        <div class="mt-3 d-grid gap-2">
            <button
                id="favorite-btn"
                class="btn btn-{% if is_favorited %}danger{% else %}outline-danger{% endif %}"
                onclick="toggleFavorite({{ movie.id }})"
            >
                <i class="bi bi-heart-fill me-1"></i>
                {% if is_favorited %}Unfavorite{% else %}Favorite{% endif %}
            </button>
            <button
                id="watchlist-btn"
                class="btn btn-{% if is_in_watchlist %}primary{% else %}outline-primary{% endif %}"
                onclick="toggleWatchlist({{ movie.id }})"
            >
                <i class="bi bi-bookmark-fill me-1"></i>
                {% if is_in_watchlist %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}
            </button>
        </div>
        {% else %}
        <div class="mt-3">
            <div class="alert alert-info text-center small py-2">
                <a href="{{ url_for('login', next=request.path) }}" class="alert-link">Log in</a> to save this movie
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Details + Trailer -->
    <div class="col-md-9">
        <!-- Overview -->
        <p class="lead">{{ movie.overview }}</p>

        <!-- Quick Stats -->
        <div class="row mt-3 mb-3">
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-star-fill text-warning"></i> TMDB Rating</strong>
                <p>{{ movie.vote_average }}/10 ({{ movie.vote_count }} votes)</p>
            </div>
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-calendar"></i> Release Date</strong>
                <p>{{ movie.release_date|format_date }}</p>
            </div>
            {% if movie.runtime %}
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-clock"></i> Runtime</strong>
                <p>{{ movie.runtime|format_runtime }}</p>
            </div>
            {% endif %}
            {% if movie.original_language %}
            <div class="col-sm-6 col-md-3 mb-2">
                <strong><i class="bi bi-translate"></i> Language</strong>
                <p>{{ movie.original_language|upper }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Genres -->
        {% if movie.genres %}
        <div class="mb-3">
            <strong>Genres:</strong>
            {% for genre in movie.genres %}
            <a href="{{ url_for('movies', genre=genre.id) }}" class="badge bg-primary text-decoration-none me-1">
                {{ genre.name }}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Directors -->
        {% if directors %}
        <p><strong>Director{{ 's' if directors|length > 1 }}:</strong>
            {% for crew, person in directors %}
            {{ person.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <!-- Trailer -->
        {% if trailer %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle-fill text-danger"></i>
                    {{ trailer.name|default('Official Trailer') }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe
                        src="https://www.youtube.com/embed/{{ trailer.key }}"
                        title="{{ trailer.name|default('Movie Trailer') }}"
                        allowfullscreen
                        loading="lazy"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- NEW FEATURE 1: Ratings & Reviews Section -->
<div class="row mt-5">
    <div class="col-12">
        <h3 class="mb-4">
            <i class="bi bi-star-fill text-warning me-2"></i>
            User Ratings & Reviews
        </h3>
    </div>
</div>

<div class="row mb-4">
    <!-- Rating Summary -->
    <div class="col-md-4 mb-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <h4 class="card-title">Average User Rating</h4>
                <div class="display-3 text-warning mb-2">
                    {% if avg_rating %}
                    <i class="bi bi-star-fill"></i>
                    {{ avg_rating }}
                    {% else %}
                    <small class="text-muted">No ratings yet</small>
                    {% endif %}
                </div>
                <p class="text-muted mb-0">
                    {{ num_ratings }} rating{{ 's' if num_ratings != 1 else '' }}
                </p>
            </div>
        </div>
    </div>

    <!-- Rate This Movie -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Rate This Movie</h5>
                {% if current_user %}
                    <form id="ratingForm" onsubmit="submitRating(event, {{ movie.id }})">
                        <div class="mb-3">
                            <label class="form-label">Your Rating:</label>
                            <div class="star-rating" id="starRating">
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star{% if user_rating and i <= user_rating.rating %}-fill{% endif %} star"
                                   data-rating="{{ i }}"
                                   onclick="selectRating({{ i }})"></i>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="rating" id="ratingValue" value="{% if user_rating %}{{ user_rating.rating }}{% endif %}">
                        </div>
                        {% if user_rating %}
                        <p class="text-muted small mb-3">
                            You rated this movie {{ user_rating.rating }} star{{ 's' if user_rating.rating != 1 else '' }}
                            on {{ user_rating.created_at.strftime('%B %d, %Y') }}
                        </p>
                        {% endif %}
                        <button type="submit" class="btn btn-warning" id="submitRatingBtn" disabled>
                            <i class="bi bi-star-fill me-1"></i>
                            {% if user_rating %}Update Rating{% else %}Submit Rating{% endif %}
                        </button>
                    </form>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <a href="{{ url_for('login', next=request.path) }}" class="alert-link">Log in</a> to rate this movie
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Write Review Section -->
{% if current_user %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Write a Review</h5>
                <form method="POST" action="{{ url_for('submit_review', movie_id=movie.id) }}">
                    <div class="mb-3">
                        <textarea class="form-control" name="review_content" rows="4"
                                  placeholder="Share your thoughts about this movie..."
                                  minlength="10" required></textarea>
                        <div class="form-text">Minimum 10 characters</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-chat-left-text me-1"></i>Submit Review
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Reviews List -->
{% if reviews %}
<div class="row mb-4">
    <div class="col-12">
        <h5 class="mb-3">
            <i class="bi bi-chat-left-quote me-2"></i>
            User Reviews ({{ num_ratings }})
        </h5>

        {% for review in reviews %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="mb-1">
                            <i class="bi bi-person-circle me-1"></i>
                            {{ review.user.username }}
                        </h6>
                        <small class="text-muted">
                            {{ review.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                            {% if review.updated_at != review.created_at %}
                            <span class="badge bg-secondary">Edited</span>
                            {% endif %}
                        </small>
                    </div>
                    {% if current_user and current_user.id == review.user_id %}
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="deleteReview({{ movie.id }}, {{ review.id }})">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
                <p class="mb-0">{{ review.content }}</p>
            </div>
        </div>
        {% endfor %}

        <!-- Review Pagination -->
        {% if total_review_pages > 1 %}
        <nav aria-label="Review pagination">
            <ul class="pagination justify-content-center">
                {% if review_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ review_page - 1 }}">Previous</a>
                </li>
                {% endif %}

                {% for p in range(1, total_review_pages + 1) %}
                    {% if p == review_page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                    {% elif p <= 3 or p >= total_review_pages - 2 or (p >= review_page - 1 and p <= review_page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                    </li>
                    {% elif p == review_page - 2 or p == review_page + 2 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if review_page < total_review_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ review_page + 1 }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% elif current_user %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    No reviews yet. Be the first to review this movie!
</div>
{% endif %}

<!-- Financial Details -->
{% if movie.budget or movie.revenue or movie.runtime %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-info-circle me-2"></i>Financial Details
                </h5>
                <div class="row">
                    {% if movie.budget %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Budget</h6>
                        <p class="h5">{{ movie.budget|format_currency }}</p>
                    </div>
                    {% endif %}

                    {% if movie.revenue %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Revenue</h6>
                        <p class="h5">{{ movie.revenue|format_currency }}</p>
                    </div>
                    {% endif %}

                    {% if movie.budget and movie.revenue %}
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">Profit/Loss</h6>
                        {% set profit = movie.revenue - movie.budget %}
                        <p class="h5 {% if profit > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ profit|format_currency }}
                        </p>
                    </div>

                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted">ROI</h6>
                        {% set roi = ((movie.revenue - movie.budget) / movie.budget * 100) if movie.budget > 0 else 0 %}
                        <p class="h5 {% if roi > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(roi) }}%
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cast -->
{% if cast %}
<h3 class="mt-4 mb-3">
    <i class="bi bi-people-fill me-2"></i>Top Cast
</h3>
<div class="row">
    {% for cast_member, person in cast %}
    <div class="col-md-2 col-sm-4 col-6 mb-3 text-center">
        <a href="{{ url_for('actor_detail', actor_id=person.id) }}" class="text-decoration-none actor-card">
            {% if person.profile_path %}
            <img src="{{ config.get_poster_url(person.profile_path, 'w185') }}"
                 class="rounded-circle mb-2 shadow-sm actor-photo"
                 style="width: 100px; height: 100px; object-fit: cover;"
                 alt="{{ person.name }}">
            {% else %}
            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-2 mx-auto shadow-sm actor-photo"
                 style="width: 100px; height: 100px;">
                <i class="bi bi-person" style="font-size: 2rem; color: #999;"></i>
            </div>
            {% endif %}
            <p class="small mb-0"><strong>{{ person.name }}</strong></p>
            <p class="small text-muted">{{ cast_member.character_name or 'Unknown' }}</p>
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- NEW FEATURE 2: Personalized Recommendations -->
{% if personalized_recommendations %}
<h3 class="mt-5 mb-3">
    <i class="bi bi-lightbulb me-2 text-warning"></i>
    Recommended For You
</h3>
<p class="text-muted mb-3">Based on your favorites</p>
<div class="row mb-4">
    {% for rec_movie in personalized_recommendations %}
    <div class="col-md-2 col-sm-4 col-6 mb-4">
        <a href="{{ url_for('movie_detail', movie_id=rec_movie.id) }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm hover-card">
                {% if rec_movie.poster_path %}
                <img src="{{ config.get_poster_url(rec_movie.poster_path, 'w342') }}"
                     class="card-img-top"
                     alt="{{ rec_movie.title }}"
                     style="height: 250px; object-fit: cover;">
                {% else %}
                <div class="bg-secondary d-flex align-items-center justify-content-center"
                     style="height: 250px;">
                    <i class="bi bi-film" style="font-size: 2rem; color: #666;"></i>
                </div>
                {% endif %}
                <div class="card-body p-2">
                    <p class="small mb-1 text-dark"><strong>{{ rec_movie.title }}</strong></p>
                    <p class="small text-muted mb-0">
                        <i class="bi bi-star-fill text-warning"></i> {{ rec_movie.vote_average }}
                    </p>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Similar Movies -->
{% if similar_movies %}
<h3 class="mt-5 mb-3">
    <i class="bi bi-collection-play me-2"></i>Similar Movies
</h3>
<div class="row">
    {% for similar_movie in similar_movies %}
    <div class="col-md-2 col-sm-4 col-6 mb-4">
        <a href="{{ url_for('movie_detail', movie_id=similar_movie.id) }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm hover-card">
                {% if similar_movie.poster_path %}
                <img src="{{ config.get_poster_url(similar_movie.poster_path, 'w342') }}"
                     class="card-img-top"
                     alt="{{ similar_movie.title }}"
                     style="height: 250px; object-fit: cover;">
                {% else %}
                <div class="bg-secondary d-flex align-items-center justify-content-center"
                     style="height: 250px;">
                    <i class="bi bi-film" style="font-size: 2rem; color: #666;"></i>
                </div>
                {% endif %}
                <div class="card-body p-2">
                    <p class="small mb-1 text-dark"><strong>{{ similar_movie.title }}</strong></p>
                    <p class="small text-muted mb-0">
                        <i class="bi bi-star-fill text-warning"></i> {{ similar_movie.vote_average }}
                    </p>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
.hover-card {
    transition: transform 0.2s ease-in-out;
}

.hover-card:hover {
    transform: translateY(-5px);
}

.actor-card {
    display: block;
    transition: transform 0.2s ease-in-out;
    color: inherit;
}

.actor-card:hover {
    transform: translateY(-3px);
}

.actor-card:hover .actor-photo {
    box-shadow: 0 8px 16px rgba(0,0,0,0.3) !important;
}

.actor-card:hover strong {
    color: #0d6efd !important;
}

.star-rating {
    font-size: 2rem;
    cursor: pointer;
}

.star-rating .star {
    color: #ddd;
    transition: color 0.2s;
}

.star-rating .star.bi-star-fill {
    color: #ffc107;
}

.star-rating .star:hover,
.star-rating .star:hover ~ .star {
    color: #ffc107;
}
</style>

<script>
let selectedRating = {% if user_rating %}{{ user_rating.rating }}{% else %}0{% endif %};

function selectRating(rating) {
    selectedRating = rating;
    document.getElementById('ratingValue').value = rating;
    document.getElementById('submitRatingBtn').disabled = false;

    // Update star display
    const stars = document.querySelectorAll('.star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
        } else {
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
        }
    });
}

async function submitRating(event, movieId) {
    event.preventDefault();

    const rating = document.getElementById('ratingValue').value;
    if (!rating || rating < 1 || rating > 5) {
        alert('Please select a rating between 1 and 5 stars');
        return;
    }

    const formData = new FormData();
    formData.append('rating', rating);

    try {
        const response = await fetch(`/movie/${movieId}/rate`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            // Update average rating display
            location.reload(); // Simple reload to show updated rating
        } else {
            alert(data.error || 'Failed to submit rating');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to submit rating');
    }
}

async function deleteReview(movieId, reviewId) {
    if (!confirm('Are you sure you want to delete this review?')) {
        return;
    }

    try {
        const response = await fetch(`/movie/${movieId}/review/${reviewId}/delete`, {
            method: 'POST'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete review');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete review');
    }
}

async function toggleFavorite(movieId) {
    const btn = document.getElementById('favorite-btn');
    const isFavorited = btn.textContent.trim().includes('Unfavorite');
    const url = `/movie/${movieId}/${isFavorited ? 'unfavorite' : 'favorite'}`;

    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
        if (isFavorited) {
            btn.innerHTML = '<i class="bi bi-heart-fill me-1"></i>Favorite';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-outline-danger');
        } else {
            btn.innerHTML = '<i class="bi bi-heart-fill me-1"></i>Unfavorite';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
        }
    }
}

async function toggleWatchlist(movieId) {
    const btn = document.getElementById('watchlist-btn');
    const inWatchlist = btn.textContent.trim().includes('Remove from Watchlist');
    const url = `/movie/${movieId}/${inWatchlist ? 'unwatchlist' : 'watchlist'}`;

    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
        if (inWatchlist) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i>Add to Watchlist';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        } else {
            btn.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i>Remove from Watchlist';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        }
    }
}
</script>

{% endblock %}
